# 8 月 2 日

## rCore-SMP

用户态和内核态的 Trap 处理一定要分开。根据现有 __alltraps 的代码，这一部分只适合于从用户态进到内核态，里面进行了上下文保存（保存到了内核栈）、页表切换等。我想，我们应该先从实现 S 态的 Trap 处理开始编写相关代码，新增 S 态的 Trap 处理。

但是首先要弄明白，S 态的中断会不会嵌套？文档里这样说的：

> 当一个 hart 处于特权模式 x 中执行时，当 xIE=1 时中断被全局使能，xIE=0 时被全局禁止。……为了支持嵌套中断，每个可以响应中断的特权模式 x 有一个中断允许位和特权模式的两层的栈。xPIE 保存 Trap 前激活的中断允许位的值，xPP 保存之前的特权模式。xPP 域只能保存最多到 x 的特权模式，因此 MPP 两位宽，SPP 一位宽。当一个从特权模式 y 进入特权模式 x 的 Trap 发生，xPIE 被设为 xIE 的值；xIE 被设为 0；xPP 被设为 y。

在启动时加入 ```println!("SIE status: {}", Sstatus::sie(&sstatus::read()));```，发现输出 false。这就让我非常不明白了，这时究竟能不能响应软中断呢？查了一会手册后，我突然意识到，IPI 能不能被接收似乎取决于目的地 Hart 是否启用了 SIE。尝试用 GDB 看，发现直接会提示连接断开，现在也还不明白为什么。

## 总结

自己的视野还是狭窄了，不能有一点小小的成绩就骄傲了，还是要培养良好的习惯。不能做个井底之蛙，不能一天天活在谎言之中。